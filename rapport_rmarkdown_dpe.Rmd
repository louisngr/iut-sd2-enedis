
---
title: "Analyse comparative des consommations énergétiques — DPE (Creuse, Corrèze, Haute‑Vienne)"
author: "Nom de l'étudiant · Équipe Greentech Solutions"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: false
    number_sections: false
    df_print: paged
params:
  departements: "23,19,87"   # Liste séparée par des virgules (ex: "23,19,87")
  type_batiment: "tous"      # "maison", "appartement" ou "tous"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width=7, fig.height=4)
library(dplyr)
library(ggplot2)
library(knitr)
library(readr)
library(scales)
```

# Introduction

La transition énergétique et la maîtrise de la consommation des logements sont des enjeux majeurs face aux défis climatiques et à la hausse des coûts de l'énergie.  
Ce rapport, réalisé dans le cadre du projet *Greentech Solutions*, vise à étudier l'association entre la **classe DPE** (Diagnostic de Performance Énergétique) et la **consommation d'énergie primaire** (kWh/m²/an) sur trois départements du massif central : **Creuse (23)**, **Corrèze (19)** et **Haute‑Vienne (87)**.  

L'approche adoptée est **exploratoire et comparative** : après présentation et préparation des données, nous produisons quelques indicateurs synthétiques (KPI) et trois visualisations ciblées permettant de répondre à la problématique principale — *dans quelle mesure la classe DPE et le type de bâtiment expliquent-ils la variabilité de la consommation ?* — en soulignant les limites méthodologiques.

# Méthodologie et données

**Source des données** : jeux DPE fournis par l'API ADEME (jeu `dpe03existant`) et pré‑traités via l'application Shiny de l'équipe. Pour exécuter ce rapport localement, placez un fichier `dpe_data.csv` dans le même dossier que ce `.Rmd` (export depuis l'application Shiny ou extraction via l'API ADEME).  

**Variables principales utilisées** :
- `code_departement_ban` : code du département (23, 19, 87)  
- `type_batiment` : type du logement (maison / appartement)  
- `etiquette_dpe` : classe DPE (A → G)  
- `etiquette_ges` : classe GES (A → G)  
- `conso_5_usages_par_m2_ep` : consommation énergie primaire (kWh/m²/an)  
- `surface_habitable_logement` : surface (m²)  
- `annee_construction` : année de construction  
- `_geopoint` : géolocalisation (latitude,longitude)

**Prétraitement** : typage numérique des variables pertinentes, retrait des valeurs absentes/non valides sur la consommation, création éventuelle d'agrégats par commune et découpage temporel par période de construction.

```{r data_prep}
# Chargement des données : priorité au fichier local 'dpe_data.csv'
if (file.exists("dpe_data.csv")) {
  donnees <- read_csv("dpe_data.csv", show_col_types = FALSE)
} else {
  stop("Fichier 'dpe_data.csv' absent. Exportez les données depuis l'app Shiny ou placez le CSV ici.")
}

# Paramètres : parsing des départements
deps <- strsplit(params$departements, ",")[[1]] %>% trimws()

# Typage et nettoyage minimal
donnees <- donnees %>%
  mutate(
    code_departement_ban = as.character(code_departement_ban),
    type_batiment = tolower(type_batiment),
    etiquette_dpe = factor(etiquette_dpe, levels = c("A","B","C","D","E","F","G")),
    etiquette_ges = factor(etiquette_ges, levels = c("A","B","C","D","E","F","G")),
    conso = as.numeric(conso_5_usages_par_m2_ep),
    surface = as.numeric(surface_habitable_logement),
    annee_construction = as.numeric(annee_construction)
  ) %>%
  filter(!is.na(conso), conso >= 0, code_departement_ban %in% deps)

# Filtre par type de bâtiment si demandé
if (tolower(params$type_batiment) != "tous") {
  donnees <- donnees %>% filter(type_batiment == tolower(params$type_batiment))
}

# Taille du jeu filtré
n_obs <- nrow(donnees)
```

# Indicateurs synthétiques (KPI)

```{r kpi}
kpi <- donnees %>%
  summarise(
    n_logements = n(),
    conso_moy = round(mean(conso, na.rm = TRUE), 1),
    conso_med = round(median(conso, na.rm = TRUE), 1),
    surface_moy = round(mean(surface, na.rm = TRUE), 1)
  )
kable(kpi, caption = "Indicateurs synthétiques pour les départements analysés")
```

# Résultats

## 1. Répartition des classes DPE par département
La figure suivante compare la part relative de chaque classe DPE entre les départements étudiés. Cette comparaison met en évidence d'éventuelles différences structurelles du parc (ex. part plus élevée de classes défavorables).

```{r fig-dpe-dist, fig.cap="Répartition des classes DPE — comparaison 23 / 19 / 87"}
dpe_colors <- c(A="#009933", B="#33cc33", C="#ccff33", D="#ffcc00", E="#ff9900", F="#ff6600", G="#ff0000")
df_dpe <- donnees %>%
  group_by(code_departement_ban, etiquette_dpe) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(code_departement_ban) %>%
  mutate(prop = n / sum(n))

ggplot(df_dpe, aes(x = etiquette_dpe, y = prop, fill = etiquette_dpe)) +
  geom_col() +
  facet_wrap(~ code_departement_ban, nrow = 1) +
  scale_fill_manual(values = dpe_colors, drop = FALSE) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(x = "Classe DPE", y = "Proportion", title = "Répartition des classes DPE par département") +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))
```

**Interprétation (bref)** : si un département présente proportionnellement plus de classes D–G, cela suggère un parc plus énergivore qui peut nécessiter prioritairement des actions d'amélioration énergétique.

## 2. Relation consommation ↔ classe DPE (boxplot)
La figure suivante montre la distribution de la consommation (kWh/m²/an) pour chaque classe DPE — l'objectif est de vérifier la tendance attendue : classes A–C associées à des consommations plus faibles.

```{r fig-dpe-box, fig.cap="Consommation par classe DPE (boxplot)"}
ggplot(donnees, aes(x = etiquette_dpe, y = pmin(conso, 1000), fill = etiquette_dpe)) +
  geom_boxplot(outlier.shape = NA) +
  scale_fill_manual(values = dpe_colors, drop = FALSE) +
  coord_cartesian(ylim = c(0, 700)) +
  labs(x = "Classe DPE", y = "Consommation (kWh/m²/an)", title = "Consommation par classe DPE") +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))
```

**Interprétation (bref)** : la médiane et la dispersion par classe renseignent sur la capacité prédictive de la classe DPE ; une large dispersion au sein d'une même classe signale la présence d'autres facteurs explicatifs (surface, année de construction, chauffage...).

## 3. Corrélation surface ↔ consommation (nuage de points + régression)
On examine la relation entre la surface habitable et la consommation. Un modèle de régression linéaire simple est ajusté pour quantifier l'association (R²).

```{r fig-scatter, fig.cap="Surface vs consommation — nuage de points et droite de régression"}
df_sc <- donnees %>% filter(!is.na(surface) & surface > 0 & conso < 2000)
if (nrow(df_sc) > 2) {
  lm_mod <- lm(conso ~ surface, data = df_sc)
  r2 <- round(summary(lm_mod)$r.squared, 3)
} else {
  r2 <- NA
}
ggplot(df_sc, aes(x = surface, y = conso)) +
  geom_point(alpha = 0.4, size = 1.5) +
  geom_smooth(method = "lm", se = TRUE, color = "#d62728") +
  labs(x = "Surface (m²)", y = "Consommation (kWh/m²/an)", subtitle = paste0("R² = ", r2),
       title = "Surface vs consommation") +
  theme_minimal()
```

**Interprétation (bref)** : un R² faible indique que la surface seule explique peu de la variabilité ; il convient alors d'introduire d'autres variables pour un modèle explicatif robuste.

# Discussion et limites

- **Caractère exploratoire** : les analyses présentées sont descriptives et ne substituent pas à une modélisation multivariée complète.  
- **Qualité des données** : données issues d'API publiques peuvent contenir des erreurs, des valeurs manquantes et des biais d'échantillonnage.  
- **Outliers et découpage** : nous avons limité l'affichage pour la clarté (p.ex. coupure à 700 kWh/m²/an) ; ces choix influencent la perception des distributions.  
- **Variables non observées** : type de chauffage, comportement des occupants, rénovations récentes ne sont pas nécessairement capturés mais influencent fortement la consommation.

# Conclusion

Cette étude comparative montre que la **classe DPE** est globalement informative (tendances centrées), mais que **la dispersion au sein de chaque classe** et la contribution modeste de variables simples (comme la surface) incitent à poursuivre l'analyse avec une approche multivariée (régression multiple, modèles hiérarchiques) et à intégrer davantage de caractéristiques (systèmes de chauffage, isolation, année de rénovation).  

---

**Usage** : pour produire un rapport filtré, modifiez le paramètre `departements` et relancez :  
```r
rmarkdown::render("rapport_academique_dpe.Rmd", params = list(departements = "23", type_batiment = "tous"))
```
